<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="bounced">
	<typeAlias alias="bouncedResultDTO" type="com.pay.txncore.dto.BouncedResultDTO" />
	<resultMap id="BaseResultMap" class="com.pay.txncore.dto.BouncedResultDTO">
		<result column="TRADE_ORDER_NO" property="tradeOrderNo"
			jdbcType="VARCHAR" />
		<result column="ORDER_ID" property="orderId" jdbcType="VARCHAR" />
		<result column="CHANNEL_ORDER_NO" property="channelOrderNo"
			jdbcType="VARCHAR" />
		<result column="CARDHOLDER_CARDNO" property="cardholderCardno"
			jdbcType="VARCHAR" />
		<result column="partner_id" property="partnerId" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="tranDate" jdbcType="TIMESTAMP" />
		<result column="ORDER_AMOUNT" property="orderAmount" jdbcType="BigDecimal" />
		<result column="CURRENCY_CODE" property="currencyCode"
			jdbcType="VARCHAR" />
		<result column="REFUND_AMOUNT" property="refundAmount"
			jdbcType="BigDecimal" />
		<result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
		<result column="AUTHORISATION" property="authorisation"
			jdbcType="VARCHAR" />
		<result column="OVER_REFUND_AMOUNT" property="overRefundAmount"
			jdbcType="BigDecimal" />
		<result column="DOING_REFUND_AMOUNT" property="doingRefundAmount"
			jdbcType="BigDecimal" />
		<result column="OVER_BOUNCED_AMOUNT" property="overBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="DOING_BOUNCED_AMOUNT" property="doingBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="SETTLEMENT_FLG" property="settlementFlg"
			jdbcType="VARCHAR" />
		<result column="ASSURE_SETTLEMENT_FLG" property="assureSettlementFlg"
			jdbcType="VARCHAR" />
		<result column="PAY_AMOUNT" property="payAmount" jdbcType="BigDecimal" />
		<result column="TRANSFER_RATE" property="transferRate"
			jdbcType="BigDecimal" />
		<result column="TRANSFER_CURRENCY_CODE" property="transferCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="CARD_ORG" property="cardOrg" jdbcType="VARCHAR" />
		<result column="SETTLEMENT_CURRENCY_CODE" property="settlementCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="SETTLEMENT_RATE" property="settlementRate"
			jdbcType="BigDecimal" />
		<result column="FLOAT_VALUE" property="floatValue" jdbcType="BigDecimal" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="MERCHANT_CODE" property="merchantCode"
			jdbcType="VARCHAR" />
		<result column="CHECK_FLAG" property="checkFlag"
			jdbcType="VARCHAR" />
		<result column="BOUNCED_REMARK" property="bouncedRemark"
			jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="BaseBatchResultMap" class="com.pay.txncore.dto.BouncedResultDTO">
		<result column="TRADE_ORDER_NO" property="tradeOrderNo"
			jdbcType="VARCHAR" />
		<result column="ORDER_ID" property="orderId" jdbcType="VARCHAR" />
		<result column="CHANNEL_ORDER_NO" property="channelOrderNo"
			jdbcType="VARCHAR" />
		<result column="CARDHOLDER_CARDNO" property="cardholderCardno"
			jdbcType="VARCHAR" />
		<result column="partner_id" property="partnerId" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="tranDate" jdbcType="TIMESTAMP" />
		<result column="ORDER_AMOUNT" property="orderAmount" jdbcType="BigDecimal" />
		<result column="CURRENCY_CODE" property="currencyCode"
			jdbcType="VARCHAR" />
		<result column="REFUND_AMOUNT" property="refundAmount"
			jdbcType="BigDecimal" />
		<result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
		<result column="AUTHORISATION" property="authorisation"
			jdbcType="VARCHAR" />
		<result column="OVER_REFUND_AMOUNT" property="overRefundAmount"
			jdbcType="BigDecimal" />
		<result column="DOING_REFUND_AMOUNT" property="doingRefundAmount"
			jdbcType="BigDecimal" />
		<result column="OVER_BOUNCED_AMOUNT" property="overBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="DOING_BOUNCED_AMOUNT" property="doingBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="SETTLEMENT_FLG" property="settlementFlg"
			jdbcType="VARCHAR" />
		<result column="ASSURE_SETTLEMENT_FLG" property="assureSettlementFlg"
			jdbcType="VARCHAR" />
		<result column="PAY_AMOUNT" property="payAmount" jdbcType="BigDecimal" />
		<result column="TRANSFER_RATE" property="transferRate"
			jdbcType="BigDecimal" />
		<result column="TRANSFER_CURRENCY_CODE" property="transferCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="CARD_ORG" property="cardOrg" jdbcType="VARCHAR" />
		<result column="SETTLEMENT_CURRENCY_CODE" property="settlementCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="SETTLEMENT_RATE" property="settlementRate"
			jdbcType="BigDecimal" />
		<result column="FLOAT_VALUE" property="floatValue" jdbcType="BigDecimal" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="MERCHANT_CODE" property="merchantCode"
			jdbcType="VARCHAR" />
		<result column="CHECK_FLAG" property="checkFlag"
			jdbcType="VARCHAR" />
		<result column="BOUNCED_REMARK" property="bouncedRemark"
			jdbcType="VARCHAR" />
		<result column="BANK_AMOUNT" property="bankAmount" jdbcType="BigDecimal" />
		<result column="BANK_CURRENCY_CODE" property="bankCurrencyCode" jdbcType="VARCHAR" />
		<result column="BATCH_NO" property="batchNo" jdbcType="VARCHAR" />
		<result column="BOUNCED_TYPE" property="bouncedType" jdbcType="VARCHAR" />
		<result column="BOUNCED_REASON" property="bouncedReason" jdbcType="VARCHAR" />
		<result column="REASON_CODE" property="reasonCode" jdbcType="VARCHAR" />
		<result column="VISABLE_CODE" property="visableCode" jdbcType="VARCHAR" />
		<result column="LAST_DATE" property="lastDate" jdbcType="TIMESTAMP" />
		<result column="CPD_DATE" property="cpdDate" jdbcType="TIMESTAMP" />
		<result column="REGISTER_FLAG" property="registerFlag" jdbcType="VARCHAR" />
		<result column="OPERATOR" property="operator" jdbcType="VARCHAR" />
		<result column="STATUS" property="status" jdbcType="VARCHAR" />
		<result column="REF_NO" property="refNo" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="BaseFraudResultMap" class="com.pay.txncore.dto.BouncedFraudResultDTO">
		<result column="CHANNEL_ORDER_NO" property="channelOrderNo"
			jdbcType="VARCHAR" />
		<result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
		<result column="AMOUNT" property="amount" jdbcType="BigDecimal" />
		<result column="PAY_AMOUNT" property="payAmount" jdbcType="BigDecimal" />
		<result column="MERCHANT_NO" property="merchantNo" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="createDate" jdbcType="VARCHAR" />
		<result column="CURRENCY_CODE" property="currencyCode"
			jdbcType="VARCHAR" />
		<result column="TRANSFER_CURRENCY_CODE" property="transferCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="CARD_ORG" property="cardOrg" jdbcType="VARCHAR" />
		<result column="PARTNER_ID" property="partnerId" jdbcType="VARCHAR" />
		<result column="MERCHANT_CODE" property="merchantCode"
			jdbcType="VARCHAR" />
		<result column="ZH_NAME" property="partnerName" jdbcType="VARCHAR" />
	</resultMap>

	<insert id="create" parameterClass="bouncedResultDTO">
		<selectKey resultClass="java.lang.Long" keyProperty="id">
			SELECT TO_CHAR(SYSDATE, 'yymmdd')||SEQ_CHARGE_BACK_CONFIG_ID.nextval FROM DUAL
		</selectKey>
		insert into BOUNCED_RESULT (ID, BATCH_NO, CHANNEL_ORDER_NO,
		TRADE_ORDER_NO, REF_NO, BUSSINESS_NO, BUSSINESS_NAME,
		CARDHOLDER_CARDNO, BANK_AMOUNT, BANK_CURRENCY_CODE, AUTHORISATION,
		TRAN_DATE, BOUNCED_TYPE, BOUNCED_REASON, REASON_CODE, VISABLE_CODE,
		ORG_CODE, STATUS, CREATE_DATE, LAST_DATE,
		REGISTER_FLAG,CPD_DATE,OLD_REF_NO,OPERATOR,REMARK
		,ORDER_AMOUNT,PAY_AMOUNT,TRANSFER_RATE,TRANSFER_CURRENCY_CODE,CARD_ORG,PARTNER_ID,SETTLEMENT_FLG,ASSURE_SETTLEMENT_FLG,
		SETTLEMENT_CURRENCY_CODE,SETTLEMENT_RATE,ORDER_ID,TRAN_CURRENCY_CODE,
		OVER_REFUND_AMOUNT,DOING_REFUND_AMOUNT,OVER_BOUNCED_AMOUNT,DOING_BOUNCED_AMOUNT,CAN_BOUNCED_AMOUNT
		,FLOAT_VALUE,GC_FLAG)
		values (#id#, #batchNo:VARCHAR#,
		#channelOrderNo:VARCHAR#,#tradeOrderNo:VARCHAR#, #refNo:VARCHAR#,
		#bussinessNo:VARCHAR#,
		#bussinessName:VARCHAR#,#cardholderCardno:VARCHAR#,
		#bankAmount:NUMERIC#,
		#bankCurrencyCode:VARCHAR#,#authorisation:VARCHAR#,
		#tranDate:VARCHAR#, #bouncedType:VARCHAR#,#bouncedReason:VARCHAR#,
		#reasonCode:VARCHAR#, #visableCode:VARCHAR#,#orgCode:VARCHAR#,
		#status:VARCHAR#, #createDate:TIMESTAMP#,#lastDate:TIMESTAMP#,
		#registerFlag:VARCHAR#,#cpdDate:VARCHAR#,#oldRefNo:VARCHAR#,
		#operator:VARCHAR#,#remark:VARCHAR#,#orderAmount:NUMERIC#,
		#payAmount:NUMERIC#,#transferRate:VARCHAR#,#transferCurrencyCode:VARCHAR#,
		#cardOrg:VARCHAR#,#partnerId:VARCHAR#,#settlementFlg:VARCHAR#
		,#assureSettlementFlg:VARCHAR#,#settlementCurrencyCode:VARCHAR#
		,#settlementRate:VARCHAR#,#orderId:VARCHAR#,#currencyCode:VARCHAR#
		,#overRefundAmount:NUMERIC#,#doingRefundAmount:NUMERIC#,#overBouncedAmount:NUMERIC#,#doingBouncedAmount:NUMERIC#,
		#canBouncedAmount:NUMERIC#,#floatValue:VARCHAR#,#merchantCode:VARCHAR#)
	</insert>
	<insert id="createTemp" parameterClass="bouncedResultDTO">
		<selectKey resultClass="java.lang.Long" keyProperty="id">
			SELECT TO_CHAR(SYSDATE, 'yymmdd')||SEQ_CHARGE_BACK_CONFIG_ID.nextval FROM DUAL
		</selectKey>
		insert into BOUNCED_RESULT_TEMP (ID, BATCH_NO, CHANNEL_ORDER_NO,
		TRADE_ORDER_NO, REF_NO, BUSSINESS_NO, BUSSINESS_NAME,
		CARDHOLDER_CARDNO, BANK_AMOUNT, BANK_CURRENCY_CODE, AUTHORISATION,
		TRAN_DATE, BOUNCED_TYPE, BOUNCED_REASON, REASON_CODE, VISABLE_CODE,
		ORG_CODE, STATUS, CREATE_DATE, LAST_DATE,
		REGISTER_FLAG,CPD_DATE,OLD_REF_NO,OPERATOR,REMARK
		,ORDER_AMOUNT,PAY_AMOUNT,TRANSFER_RATE,TRANSFER_CURRENCY_CODE,CARD_ORG,PARTNER_ID,SETTLEMENT_FLG,ASSURE_SETTLEMENT_FLG,
		SETTLEMENT_CURRENCY_CODE,SETTLEMENT_RATE,ORDER_ID,TRAN_CURRENCY_CODE,
		OVER_REFUND_AMOUNT,DOING_REFUND_AMOUNT,OVER_BOUNCED_AMOUNT,DOING_BOUNCED_AMOUNT,CAN_BOUNCED_AMOUNT
		,FLOAT_VALUE,GC_FLAG)
		values (#id#, #batchNo:VARCHAR#,
		#channelOrderNo:VARCHAR#,#tradeOrderNo:VARCHAR#, #refNo:VARCHAR#,
		#bussinessNo:VARCHAR#,
		#bussinessName:VARCHAR#,#cardholderCardno:VARCHAR#,
		#bankAmount:NUMERIC#,
		#bankCurrencyCode:VARCHAR#,#authorisation:VARCHAR#,
		#tranDate:VARCHAR#, #bouncedType:VARCHAR#,#bouncedReason:VARCHAR#,
		#reasonCode:VARCHAR#, #visableCode:VARCHAR#,#orgCode:VARCHAR#,
		#status:VARCHAR#, #createDate:TIMESTAMP#,#lastDate:TIMESTAMP#,
		#registerFlag:VARCHAR#,#cpdDate:VARCHAR#,#oldRefNo:VARCHAR#,
		#operator:VARCHAR#,#remark:VARCHAR#,#orderAmount:NUMERIC#,
		#payAmount:NUMERIC#,#transferRate:VARCHAR#,#transferCurrencyCode:VARCHAR#,
		#cardOrg:VARCHAR#,#partnerId:VARCHAR#,#settlementFlg:VARCHAR#
		,#assureSettlementFlg:VARCHAR#,#settlementCurrencyCode:VARCHAR#
		,#settlementRate:VARCHAR#,#orderId:VARCHAR#,#currencyCode:VARCHAR#
		,#overRefundAmount:NUMERIC#,#doingRefundAmount:NUMERIC#,#overBouncedAmount:NUMERIC#,#doingBouncedAmount:NUMERIC#,
		#canBouncedAmount:NUMERIC#,#floatValue:VARCHAR#,#merchantCode:VARCHAR#)
	</insert>
	<select id="bouncedQuery" resultMap="BaseResultMap"
		parameterClass="java.util.HashMap">
		select
		t.TRADE_ORDER_NO,t.ORDER_ID,t.PARTNER_ID,co.CHANNEL_ORDER_NO,co.CARD_ORG,
		co.ORG_CODE,
		tf.CARDHOLDER_CARDNO,t.CURRENCY_CODE,co.PAY_AMOUNT,co.TRANSFER_RATE,co.TRANSFER_CURRENCY_CODE,
		t.CREATE_DATE,t.ORDER_AMOUNT,
		t.REFUND_AMOUNT, co.AUTHORISATION,
		t.OVER_REFUND_AMOUNT, t.DOING_REFUND_AMOUNT,
		t.OVER_BOUNCED_AMOUNT,t.DOING_BOUNCED_AMOUNT,
		pso.SETTLEMENT_FLG,pso.ASSURE_SETTLEMENT_FLG,pso.SETTLEMENT_CURRENCY_CODE,pso.SETTLEMENT_RATE
		,co.FLOAT_VALUE,(case when t.ORDER_AMOUNT>t.OVER_BOUNCED_AMOUNT and
		t.OVER_BOUNCED_AMOUNT>0 then '已部分拒付'
		when
		t.ORDER_AMOUNT=t.OVER_BOUNCED_AMOUNT then '已全额拒付'
		when
		t.ORDER_AMOUNT>t.OVER_REFUND_AMOUNT and t.OVER_REFUND_AMOUNT>0 then
		'已部分退款'
		when t.ORDER_AMOUNT=t.OVER_REFUND_AMOUNT then '已全额退款'
		else ''
		end) as REMARK,substr(ent.MERCHANT_CODE,0,1) as MERCHANT_CODE,
		t.CHECK_FLAG,t.BOUNCED_REMARK
		from
		fi.channel_order co,fi.payment_order po,fi.trade_order t,
		fi.PARTNER_SETTLEMENT_ORDER pso,fi.TRADE_EXTENDS
		tf,acc.T_ENTERPRISE_BASE ent
		where
		t.TRADE_ORDER_NO=pso.TRADE_ORDER_NO
		and co.PAYMENT_ORDER_NO=po.payment_order_no and po.trade_order_no=t.TRADE_ORDER_NO
		and t.TRADE_ORDER_NO=tf.TRADE_ORDER_NO
		and t.PARTNER_ID=ent.MEMBER_CODE
		and t.STATUS in ('3','4') and
		t.ORDER_AMOUNT > 0 and co.STATUS='1'
		<isNotEmpty prepend="AND" property="cardNo">
			tf.CARDHOLDER_CARDNO=#cardNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="cardNoLike">
			tf.CARDHOLDER_CARDNO
			like #cardNoLike#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="authorisation">
			co.AUTHORISATION=#authorisation#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="tranDate">
			to_char(t.CREATE_DATE,
			'yyyy-MM-dd')=#tranDate#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="tradeOrderNo">
			t.TRADE_ORDER_NO=#tradeOrderNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="channelOrderNo">
			co.CHANNEL_ORDER_NO=#channelOrderNo#
		</isNotEmpty>
		order by TRADE_ORDER_NO ,co.CHANNEL_ORDER_NO,CREATE_DATE desc
	</select>
	
	<select id="batchBouncedQuery" resultMap="BaseBatchResultMap"
		parameterClass="java.util.HashMap">
		select  T.*,br.BANK_AMOUNT,br.BANK_CURRENCY_CODE,br.BATCH_NO
		,br.BOUNCED_TYPE,br.BOUNCED_REASON,br.REASON_CODE,br.VISABLE_CODE,br.LAST_DATE,
		br.REGISTER_FLAG,br.CPD_DATE,br.OPERATOR,br.STATUS,br.REF_NO
		from fi.bounced_result_temp br
	left join 	
          (select pso.id,
		t.TRADE_ORDER_NO,t.ORDER_ID,t.PARTNER_ID,co.CHANNEL_ORDER_NO,co.CARD_ORG,
		co.ORG_CODE,
		tf.CARDHOLDER_CARDNO,t.CURRENCY_CODE,co.PAY_AMOUNT,co.TRANSFER_RATE,co.TRANSFER_CURRENCY_CODE,
		t.CREATE_DATE,t.ORDER_AMOUNT,
		t.REFUND_AMOUNT, co.AUTHORISATION,
		t.OVER_REFUND_AMOUNT, t.DOING_REFUND_AMOUNT,
		t.OVER_BOUNCED_AMOUNT,t.DOING_BOUNCED_AMOUNT,
		pso.SETTLEMENT_FLG,ASSURE_SETTLEMENT_FLG,pso.SETTLEMENT_CURRENCY_CODE,pso.SETTLEMENT_RATE
		,co.FLOAT_VALUE,(case when t.ORDER_AMOUNT>t.OVER_BOUNCED_AMOUNT and
		t.OVER_BOUNCED_AMOUNT>0 then '已部分拒付'
		when
		t.ORDER_AMOUNT=t.OVER_BOUNCED_AMOUNT then '已全额拒付'
		when
		t.ORDER_AMOUNT>t.OVER_REFUND_AMOUNT and t.OVER_REFUND_AMOUNT>0 then
		'已部分退款'
		when t.ORDER_AMOUNT=t.OVER_REFUND_AMOUNT then '已全额退款'
		else ''
		end) as REMARK,substr(ent.MERCHANT_CODE,0,1) as MERCHANT_CODE,
		t.CHECK_FLAG,t.BOUNCED_REMARK
		from
		fi.channel_order co,fi.payment_order po,fi.trade_order t,
		fi.PARTNER_SETTLEMENT_ORDER pso,fi.TRADE_EXTENDS
		tf,acc.T_ENTERPRISE_BASE ent
		where
		t.TRADE_ORDER_NO=pso.TRADE_ORDER_NO
		and co.PAYMENT_ORDER_NO=po.payment_order_no 
		and po.trade_order_no=t.TRADE_ORDER_NO
		and t.TRADE_ORDER_NO=tf.TRADE_ORDER_NO
		and
		t.PARTNER_ID=ent.MEMBER_CODE
		and t.STATUS in ('3','4') and
		t.ORDER_AMOUNT > 0 and co.STATUS='1' ) T 
		on br.ORG_CODE=t.ORG_CODE and (br.TRADE_ORDER_NO=T.TRADE_ORDER_NO or br.CHANNEL_ORDER_NO=T.CHANNEL_ORDER_NO
		or (
		T.AUTHORISATION=br.AUTHORISATION 
		and to_char(T.CREATE_DATE,'yyyy-MM-dd')=to_char(br.tran_date,'yyyy-MM-dd')
		and T.CARDHOLDER_CARDNO like br.CARDHOLDER_CARDNO ))
		where br.batch_no=#batchNo# 
	</select>
	<update id="bouncedResultUpdate" parameterClass="bouncedResultDTO">
        UPDATE BOUNCED_RESULT
        <dynamic prepend="SET"> 
<isNotNull prepend="," property="batchNo" >BATCH_NO =#batchNo#                    </isNotNull>   
<isNotNull prepend="," property="orderId" >ORDER_ID =#orderId#                     </isNotNull>
<isNotNull prepend="," property="channelOrderNo" >CHANNEL_ORDER_NO =#channelOrderNo#             </isNotNull>
<isNotNull prepend="," property="tradeOrderNo" >TRADE_ORDER_NO =#tradeOrderNo#               </isNotNull>
<isNotNull prepend="," property="refNo" >REF_NO =#refNo#                       </isNotNull>
<isNotNull prepend="," property="bussinessNo" >BUSSINESS_NO =#bussinessNo#                 </isNotNull>
<isNotNull prepend="," property="bussinessName" >BUSSINESS_NAME =#bussinessName#               </isNotNull>
<isNotNull prepend="," property="cardholderCardno" >CARDHOLDER_CARDNO =#cardholderCardno#            </isNotNull>
<isNotNull prepend="," property="bankAmount" >BANK_AMOUNT =#bankAmount#                  </isNotNull>
<isNotNull prepend="," property="bankCurrencyCode" >BANK_CURRENCY_CODE =#bankCurrencyCode#           </isNotNull>
<isNotNull prepend="," property="authorisation" >AUTHORISATION =#authorisation#                </isNotNull>
<isNotNull prepend="," property="tranDate" >TRAN_DATE =#tranDate#                    </isNotNull>
<isNotNull prepend="," property="bouncedType" >BOUNCED_TYPE =#bouncedType#                 </isNotNull>
<isNotNull prepend="," property="bouncedReason" >BOUNCED_REASON =#bouncedReason#               </isNotNull>
<isNotNull prepend="," property="reasonCode" >REASON_CODE =#reasonCode#                  </isNotNull>
<isNotNull prepend="," property="visableCode" >VISABLE_CODE =#visableCode#                 </isNotNull>
<isNotNull prepend="," property="orgCode" >ORG_CODE =#orgCode#                     </isNotNull>
<isNotNull prepend="," property="overRefundAmount" >OVER_REFUND_AMOUNT =#overRefundAmount#           </isNotNull>
<isNotNull prepend="," property="doingRefundAmount" >DOING_REFUND_AMOUNT =#doingRefundAmount#          </isNotNull>
<isNotNull prepend="," property="overBouncedAmount" >OVER_BOUNCED_AMOUNT =#overBouncedAmount#          </isNotNull>
<isNotNull prepend="," property="canBouncedAmount" >CAN_BOUNCED_AMOUNT =#canBouncedAmount#           </isNotNull>
<isNotNull prepend="," property="doingBouncedAmount" >DOING_BOUNCED_AMOUNT =#doingBouncedAmount#         </isNotNull>
<isNotNull prepend="," property="orderAmount" >ORDER_AMOUNT =#orderAmount#                 </isNotNull>
<isNotNull prepend="," property="payAmount" >PAY_AMOUNT  =#payAmount#                  </isNotNull>
<isNotNull prepend="," property="transferRate" >TRANSFER_RATE  =#transferRate#               </isNotNull>
<isNotNull prepend="," property="transferCurrencyCode" >TRANSFER_CURRENCY_CODE =#transferCurrencyCode#       </isNotNull>
<isNotNull prepend="," property="cardOrg" >CARD_ORG  =#cardOrg#                    </isNotNull>
<isNotNull prepend="," property="partnerId" >PARTNER_ID  =#partnerId#                  </isNotNull>
<isNotNull prepend="," property="settlementFlg" >SETTLEMENT_FLG  =#settlementFlg#              </isNotNull>
<isNotNull prepend="," property="assureSettlementFlg" >ASSURE_SETTLEMENT_FLG =#assureSettlementFlg#        </isNotNull>
<isNotNull prepend="," property="status" >STATUS  =#status#                      </isNotNull>
<isNotNull prepend="," property="createDate" >CREATE_DATE  =#createDate#                 </isNotNull>
<isNotNull prepend="," property="lastDate" >LAST_DATE =#lastDate#                    </isNotNull>
<isNotNull prepend="," property="registerFlag" >REGISTER_FLAG  =#registerFlag#               </isNotNull>
<isNotNull prepend="," property="cpdDate" >CPD_DATE =#cpdDate#                     </isNotNull>
<isNotNull prepend="," property="oldRefNo" >OLD_REF_NO  =#oldRefNo#                  </isNotNull>
<isNotNull prepend="," property="operator" >OPERATOR =#operator#                     </isNotNull>
<isNotNull prepend="," property="remark" >REMARK =#remark#                       </isNotNull>
<isNotNull prepend="," property="settlementCurrencyCode" >SETTLEMENT_CURRENCY_CODE =#settlementCurrencyCode#     </isNotNull>
<isNotNull prepend="," property="settlementRate" >SETTLEMENT_RATE  =#settlementRate#             </isNotNull>
<isNotNull prepend="," property="floatValue" >FLOAT_VALUE =#floatValue#                  </isNotNull>
<isNotNull prepend="," property="merchantCode" >GC_FLAG    =#merchantCode#                   </isNotNull>                 
        </dynamic>
        <dynamic prepend="WHERE">
           <isNotNull prepend="and" property="id">
            id = #id#
        	</isNotNull>
        	<isNotNull prepend="AND" property="ids">
				ltrim(rtrim(id)) in
				<iterate conjunction="," open="(" close=")" property="ids">
				#ids[]#
				</iterate>
			</isNotNull>
        </dynamic>
    </update>
	<resultMap id="BouncedResultMap" class="com.pay.txncore.dto.BouncedResultDTO">
		<result column="ID" property="id" jdbcType="VARCHAR" />
		<result column="BATCH_NO" property="batchNo" jdbcType="VARCHAR" />
		<result column="TRADE_ORDER_NO" property="tradeOrderNo"
			jdbcType="VARCHAR" />
		<result column="REF_NO" property="refNo"
			jdbcType="VARCHAR" />
		<result column="ORDER_ID" property="orderId" jdbcType="VARCHAR" />
		<result column="CHANNEL_ORDER_NO" property="channelOrderNo"
			jdbcType="VARCHAR" />
		<result column="CARDHOLDER_CARDNO" property="cardholderCardno"
			jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
		<result column="TRAN_DATE" property="tranDate" jdbcType="TIMESTAMP" />
		<result column="LAST_DATE" property="lastDate" jdbcType="TIMESTAMP" />
		<result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
		<result column="AUTHORISATION" property="authorisation"
			jdbcType="VARCHAR" />
		<result column="OVER_REFUND_AMOUNT" property="overRefundAmount"
			jdbcType="BigDecimal" />
		<result column="DOING_REFUND_AMOUNT" property="doingRefundAmount"
			jdbcType="BigDecimal" />
		<result column="OVER_BOUNCED_AMOUNT" property="overBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="CAN_BOUNCED_AMOUNT" property="canBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="DOING_BOUNCED_AMOUNT" property="doingBouncedAmount"
			jdbcType="BigDecimal" />
		<result column="ORDER_AMOUNT" property="orderAmount" jdbcType="BigDecimal" />
		<result column="PAY_AMOUNT" property="payAmount" jdbcType="BigDecimal" />
		<result column="TRANSFER_RATE" property="transferRate"
			jdbcType="BigDecimal" />
		<result column="TRANSFER_CURRENCY_CODE" property="transferCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="CARD_ORG" property="cardOrg" jdbcType="VARCHAR" />
		<result column="PARTNER_ID" property="partnerId" jdbcType="VARCHAR" />
		<result column="SETTLEMENT_FLG" property="settlementFlg"
			jdbcType="VARCHAR" />
		<result column="ASSURE_SETTLEMENT_FLG" property="assureSettlementFlg"
			jdbcType="VARCHAR" />
		<result column="OPERATOR" property="operator" jdbcType="VARCHAR" />
		<result column="BOUNCED_TYPE" property="bouncedType" jdbcType="VARCHAR" />
		<result column="STATUS" property="status" jdbcType="VARCHAR" />
		<result column="REGISTER_FLAG" property="registerFlag"
			jdbcType="VARCHAR" />
		<result column="SETTLEMENT_CURRENCY_CODE" property="settlementCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="TRAN_CURRENCY_CODE" property="currencyCode"
			jdbcType="VARCHAR" />
		<result column="SETTLEMENT_RATE" property="settlementRate"
			jdbcType="BigDecimal" />
		<result column="FLOAT_VALUE" property="floatValue" jdbcType="BigDecimal" />
		<result column="BANK_AMOUNT" property="bankAmount" jdbcType="BigDecimal" />
		<result column="REASON_CODE" property="reasonCode" jdbcType="VARCHAR" />
		<result column="VISABLE_CODE" property="visableCode" jdbcType="VARCHAR" />
		<result column="BANK_CURRENCY_CODE" property="bankCurrencyCode"
			jdbcType="VARCHAR" />
		<result column="CPD_DATE" property="cpdDate" jdbcType="VARCHAR" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="MERCHANT_CODE" property="merchantCode"
			jdbcType="VARCHAR" />
		<result column="CHECK_FLAG" property="checkFlag"
			jdbcType="VARCHAR" />
		<result column="BOUNCED_REMARK" property="bouncedRemark"
			jdbcType="VARCHAR" />
	</resultMap>
	<select id="bouncedResultQuery" resultMap="BouncedResultMap">
		SELECT
		bt.ID,
		bt.BATCH_NO,
		t.ORDER_ID,
		bt.CHANNEL_ORDER_NO,
		bt.TRADE_ORDER_NO,
		bt.REF_NO,
		bt.BUSSINESS_NO,
		bt.BUSSINESS_NAME,
		bt.CARDHOLDER_CARDNO,
		bt.BANK_AMOUNT,
		bt.BANK_CURRENCY_CODE,
		bt.AUTHORISATION,
		bt.TRAN_DATE,
		bt.BOUNCED_TYPE,
		bt.BOUNCED_REASON,
		bt.REASON_CODE,
		bt.VISABLE_CODE,
		bt.ORG_CODE,
		bt.STATUS,
		bt.CREATE_DATE,
		bt.LAST_DATE,
		bt.REGISTER_FLAG,
		bt.CPD_DATE,
		bt.OLD_REF_NO,
		bt.OPERATOR,
		bt.REMARK,
		bt.ORDER_AMOUNT,
		bt.PAY_AMOUNT,
		bt.TRANSFER_RATE,
		bt.TRANSFER_CURRENCY_CODE,
		bt.CARD_ORG,
		t.PARTNER_ID,
		pso.SETTLEMENT_FLG,
		pso.ASSURE_SETTLEMENT_FLG,
		pso.SETTLEMENT_CURRENCY_CODE,
		pso.SETTLEMENT_RATE,
		bt.TRAN_CURRENCY_CODE,
		bt.FLOAT_VALUE,
		t.OVER_REFUND_AMOUNT,
		t.DOING_REFUND_AMOUNT,
		t.OVER_BOUNCED_AMOUNT,
		t.DOING_BOUNCED_AMOUNT,
		t.REFUND_AMOUNT CAN_BOUNCED_AMOUNT,
		bt.GC_FLAG AS MERCHANT_CODE,
		t.CHECK_FLAG,t.BOUNCED_REMARK
		FROM
		BOUNCED_RESULT bt 
		left join TRADE_ORDER t on bt.trade_order_no =t.trade_order_no
		left join PARTNER_SETTLEMENT_ORDER pso on t.trade_order_no=pso.TRADE_ORDER_NO

		where 1=1
		<isNotEmpty prepend="AND" property="cardNo">
			bt.CARDHOLDER_CARDNO=#cardNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="id">
			bt.id=#id#
		</isNotEmpty>
	<isNotEmpty prepend="AND" property="ids">
		ltrim(rtrim(bt.id)) in
		<iterate conjunction="," open="(" close=")" property="ids">
			#ids[]#
		</iterate>
	</isNotEmpty>
		<isNotEmpty prepend="AND" property="authorisation">
			bt.AUTHORISATION=#authorisation#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="tradeOrderNo">
			bt.TRADE_ORDER_NO=#tradeOrderNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="canBouncedAmount">
			t.REFUND_AMOUNT=#canBouncedAmount#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="channelOrderNo">
			bt.CHANNEL_ORDER_NO=#channelOrderNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="orgCode">
			bt.ORG_CODE=#orgCode#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="batchNo">
			bt.BATCH_NO=#batchNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="bouncedType">
			bt.BOUNCED_TYPE=#bouncedType#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="registerFlag">
			bt.REGISTER_FLAG=#registerFlag#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="refNo">
			bt.REF_NO=#refNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="operator">
			bt.OPERATOR=#operator#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="status">
			bt.STATUS=#status#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="statuss">
		ltrim(rtrim(bt.STATUS)) in
		<iterate conjunction="," open="(" close=")" property="statuss">
			#statuss[]#
		</iterate>
	</isNotEmpty>
		<isNotEmpty prepend="AND" property="beginCreateDate">
			bt.CREATE_DATE <![CDATA[>=]]>
			to_date(#beginCreateDate#, 'yyyy-MM-dd hh24:mi:ss')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="endCreateDate">
			bt.CREATE_DATE <![CDATA[<]]>
			to_date(#endCreateDate#, 'yyyy-MM-dd hh24:mi:ss')+1
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="beginLastDate">
			bt.LAST_DATE <![CDATA[>=]]>
			to_date(#beginLastDate#, 'yyyy-MM-dd hh24:mi:ss')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="endLastDate">
			bt.LAST_DATE <![CDATA[<]]>
			to_date(#endLastDate#, 'yyyy-MM-dd hh24:mi:ss')+1
		</isNotEmpty>
	</select>
	<select id="bouncedResultQuery_COUNT" resultClass="java.lang.Integer">
		SELECT
		count(1)
		FROM
		BOUNCED_RESULT bt 
		left join TRADE_ORDER t on bt.trade_order_no =t.trade_order_no
		left join PARTNER_SETTLEMENT_ORDER pso on t.trade_order_no=pso.TRADE_ORDER_NO

		where 1=1
		<isNotEmpty prepend="AND" property="cardNo">
			bt.CARDHOLDER_CARDNO=#cardNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="id">
			bt.id=#id#
		</isNotEmpty>
	<isNotEmpty prepend="AND" property="ids">
		ltrim(rtrim(bt.id)) in
		<iterate conjunction="," open="(" close=")" property="ids">
			#ids[]#
		</iterate>
	</isNotEmpty>
		<isNotEmpty prepend="AND" property="authorisation">
			bt.AUTHORISATION=#authorisation#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="tradeOrderNo">
			bt.TRADE_ORDER_NO=#tradeOrderNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="canBouncedAmount">
			t.REFUND_AMOUNT=#canBouncedAmount#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="channelOrderNo">
			bt.CHANNEL_ORDER_NO=#channelOrderNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="orgCode">
			bt.ORG_CODE=#orgCode#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="batchNo">
			bt.BATCH_NO=#batchNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="bouncedType">
			bt.BOUNCED_TYPE=#bouncedType#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="registerFlag">
			bt.REGISTER_FLAG=#registerFlag#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="refNo">
			bt.REF_NO=#refNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="operator">
			bt.OPERATOR=#operator#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="status">
			bt.STATUS=#status#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="statuss">
		ltrim(rtrim(bt.STATUS)) in
		<iterate conjunction="," open="(" close=")" property="statuss">
			#statuss[]#
		</iterate>
	</isNotEmpty>
		<isNotEmpty prepend="AND" property="beginCreateDate">
			bt.CREATE_DATE <![CDATA[>=]]>
			to_date(#beginCreateDate#, 'yyyy-MM-dd hh24:mi:ss')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="endCreateDate">
			bt.CREATE_DATE <![CDATA[<]]>
			to_date(#endCreateDate#, 'yyyy-MM-dd hh24:mi:ss')+1
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="beginLastDate">
			bt.LAST_DATE <![CDATA[>=]]>
			to_date(#beginLastDate#, 'yyyy-MM-dd hh24:mi:ss')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="endLastDate">
			bt.LAST_DATE <![CDATA[<]]>
			to_date(#endLastDate#, 'yyyy-MM-dd hh24:mi:ss')+1
		</isNotEmpty>
	</select>
	<select id="bouncedFraudQuery" resultMap="BaseFraudResultMap"
		parameterClass="java.util.HashMap">
		select
		co.CHANNEL_ORDER_NO,
		co.ORG_CODE,
		co.PAY_AMOUNT,
		co.AMOUNT,
		co.MERCHANT_NO,
		to_char(co.CREATE_DATE,'yyyymmdd') as CREATE_DATE,
		co.CURRENCY_CODE,
		co.TRANSFER_CURRENCY_CODE,
		co.CARD_ORG,
		po.PAYEE as PARTNER_ID,
		e.MERCHANT_CODE,
		e.ZH_NAME
from   fi.channel_order co
left join fi.payment_order po on co.PAYMENT_ORDER_NO=po.payment_order_no
left join acc.T_ENTERPRISE_BASE   e on e.MEMBER_CODE =po.PAYEE   
where    
e.AUDI_STATUS=1 and 
co.status='1'
		<isNotEmpty prepend="AND" property="beginCreateDate">
			co.CREATE_DATE <![CDATA[>=]]>
			to_date(#beginCreateDate#, 'yyyy-MM-dd hh24:mi:ss')
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="endCreateDate">
			co.CREATE_DATE <![CDATA[<]]>
			to_date(#endCreateDate#, 'yyyy-MM-dd hh24:mi:ss')+1
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="createDate">
			and
			to_char(co.CREATE_DATE,'yyyy-mm-dd') like '#createDate#%'
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="orgCode">
			co.ORG_CODE=#orgCode#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="orgCode">
			co.MERCHANT_NO=#orgCode#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="status">
			co.status=#status#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="partnerId">
			po.PAYEE=#partnerId#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="merchantNo">
			co.MERCHANT_NO=#merchantNo#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="cardOrg">
			co.CARD_ORG=#cardOrg#
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="flag">
			substr(e.MERCHANT_CODE,0,1)=#flag#
		</isNotEmpty>
		order by co.CREATE_DATE desc
	</select>
	<delete id="deleteTemp" >
  	delete from bounced_result_temp
  	</delete>
</sqlMap>